# PATCH FOR: first_run_setup.pyw
# MAJOR CHANGES: Add 3 path configuration screens + launch checkbox

LOCATION: Around line 70-120 (where class variables are initialized in __init__)

After the line: self.backend = SetupWizardBackend()

ADD THESE NEW INSTANCE VARIABLES:
```python
        # Path configuration variables
        self.ollama_models_path = None
        self.database_path = None
        self.install_dir = None
        self.launch_after_install = False
        
        # Deduplicated model list
        self.available_models = []
```

---

LOCATION: Around line 150-170 (where screens are defined)

OLD:
```python
        # Define screens
        self.screens = [
            self._create_welcome_screen,
            self._create_dependencies_screen,
            self._create_configuration_screen,
            self._create_finish_screen
        ]
```

NEW:
```python
        # Define screens - UPDATED WITH NEW PATH CONFIGURATION SCREENS
        self.screens = [
            self._create_welcome_screen,
            self._create_dependencies_screen,
            self._create_paths_screen,  # NEW: Paths configuration
            self._create_configuration_screen,
            self._create_finish_screen
        ]
```

---

LOCATION: Find the section where you create screen titles (around line 280-300)

In the _show_screen method, add this case for the new paths screen:

ADD BEFORE the return statement of _show_screen:
```python
        elif self.current_screen == 2:
            self.title_label.configure(text="Step 3 of 5: Configure Paths")
            # Show the three path input widgets...
```

---

LOCATION: Add NEW METHOD after _create_dependencies_screen method

ADD THIS NEW COMPLETE METHOD:
```python
def _create_paths_screen(self):
    """Screen 3: Configure paths (models, database, install directory)."""
    
    frame = self._create_screen_frame()
    
    # Header
    header_label = ctk.CTkLabel(
        frame,
        text="Configure Storage Paths",
        font=("Arial", 16, "bold"),
        text_color=TEXT_COLOR
    )
    header_label.pack(pady=(0, 10))
    
    desc_label = ctk.CTkLabel(
        frame,
        text="Set the locations where your models, database, and app will be stored.",
        font=("Arial", 12),
        text_color=MUTED_COLOR,
        wraplength=500
    )
    desc_label.pack(pady=(0, 20))
    
    # --- Ollama Models Path ---
    models_frame = ctk.CTkFrame(frame, fg_color=INPUT_COLOR, corner_radius=8)
    models_frame.pack(fill="x", pady=10)
    
    models_label = ctk.CTkLabel(
        models_frame,
        text="üìÅ Ollama Models Location:",
        font=("Arial", 11, "bold"),
        text_color=TEXT_COLOR
    )
    models_label.pack(anchor="w", padx=12, pady=(8, 4))
    
    self.models_path_var = ctk.StringVar(value=f"{Path.home()}\\.ollama\\models")
    
    models_input = ctk.CTkEntry(
        models_frame,
        textvariable=self.models_path_var,
        fg_color=PANEL_COLOR,
        text_color=TEXT_COLOR,
        border_color=BORDER_COLOR,
        border_width=1,
        height=32
    )
    models_input.pack(fill="x", padx=12, pady=(0, 8))
    
    models_browse_btn = ctk.CTkButton(
        models_frame,
        text="Browse",
        width=80,
        height=28,
        fg_color=BUTTON_COLOR,
        hover_color=BUTTON_HOVER,
        command=lambda: self._browse_folder(self.models_path_var, "Select Ollama Models Folder")
    )
    models_browse_btn.pack(anchor="e", padx=12, pady=(0, 12))
    
    # --- Database Path ---
    db_frame = ctk.CTkFrame(frame, fg_color=INPUT_COLOR, corner_radius=8)
    db_frame.pack(fill="x", pady=10)
    
    db_label = ctk.CTkLabel(
        db_frame,
        text="üóÑÔ∏è Vector Database Location:",
        font=("Arial", 11, "bold"),
        text_color=TEXT_COLOR
    )
    db_label.pack(anchor="w", padx=12, pady=(8, 4))
    
    self.db_path_var = ctk.StringVar(value="./chroma_db")
    
    db_input = ctk.CTkEntry(
        db_frame,
        textvariable=self.db_path_var,
        fg_color=PANEL_COLOR,
        text_color=TEXT_COLOR,
        border_color=BORDER_COLOR,
        border_width=1,
        height=32
    )
    db_input.pack(fill="x", padx=12, pady=(0, 8))
    
    db_browse_btn = ctk.CTkButton(
        db_frame,
        text="Browse",
        width=80,
        height=28,
        fg_color=BUTTON_COLOR,
        hover_color=BUTTON_HOVER,
        command=lambda: self._browse_folder(self.db_path_var, "Select Database Folder")
    )
    db_browse_btn.pack(anchor="e", padx=12, pady=(0, 12))
    
    # --- Install Directory ---
    install_frame = ctk.CTkFrame(frame, fg_color=INPUT_COLOR, corner_radius=8)
    install_frame.pack(fill="x", pady=10)
    
    install_label = ctk.CTkLabel(
        install_frame,
        text="üìÇ Application Installation Directory:",
        font=("Arial", 11, "bold"),
        text_color=TEXT_COLOR
    )
    install_label.pack(anchor="w", padx=12, pady=(8, 4))
    
    self.install_path_var = ctk.StringVar(value=str(self.backend.script_dir))
    
    install_input = ctk.CTkEntry(
        install_frame,
        textvariable=self.install_path_var,
        fg_color=PANEL_COLOR,
        text_color=TEXT_COLOR,
        border_color=BORDER_COLOR,
        border_width=1,
        height=32
    )
    install_input.pack(fill="x", padx=12, pady=(0, 8))
    
    install_browse_btn = ctk.CTkButton(
        install_frame,
        text="Browse",
        width=80,
        height=28,
        fg_color=BUTTON_COLOR,
        hover_color=BUTTON_HOVER,
        command=lambda: self._browse_folder(self.install_path_var, "Select Installation Folder")
    )
    install_browse_btn.pack(anchor="e", padx=12, pady=(0, 12))
    
    return frame

def _browse_folder(self, string_var: ctk.StringVar, title: str):
    """Open folder browser dialog and update string variable."""
    folder = filedialog.askdirectory(title=title)
    if folder:
        string_var.set(folder)
```

---

LOCATION: Find _create_configuration_screen method (around line 300-400)

UPDATE THE SCREEN NUMBER REFERENCE:
OLD:
```python
def _create_configuration_screen(self):
    """Screen 3: Configuration."""
```

NEW:
```python
def _create_configuration_screen(self):
    """Screen 4: Model and Name Configuration."""
```

Also update the title in _show_screen() for this screen from "Step 3 of 4" to "Step 4 of 5"

---

LOCATION: In _create_configuration_screen, find where model dropdown is created

ADD MODEL DEDUPLICATION when setting dropdown values:
```python
        # Get available models and deduplicate
        if self.available_models:
            deduped_models = list(dict.fromkeys(self.available_models))
            self.model_dropdown.configure(values=deduped_models)
            # Set default
            if deduped_models:
                self.model_dropdown.set(deduped_models[0])
```

---

LOCATION: Find _create_finish_screen method (around line 450-500)

OLD:
```python
def _create_finish_screen(self):
    """Screen 4: Finish."""
```

NEW:
```python
def _create_finish_screen(self):
    """Screen 5: Launch Options & Finish."""
```

REPLACE THE ENTIRE finish screen with:

```python
def _create_finish_screen(self):
    """Screen 5: Launch Options & Finish."""
    
    frame = self._create_screen_frame()
    
    # Header
    header_label = ctk.CTkLabel(
        frame,
        text="Setup Complete!",
        font=("Arial", 18, "bold"),
        text_color=SUCCESS_COLOR
    )
    header_label.pack(pady=(0, 10))
    
    desc_label = ctk.CTkLabel(
        frame,
        text="Configuration has been saved. Choose your preferences below.",
        font=("Arial", 12),
        text_color=MUTED_COLOR,
        wraplength=500
    )
    desc_label.pack(pady=(0, 20))
    
    # Options frame
    options_frame = ctk.CTkFrame(frame, fg_color=INPUT_COLOR, corner_radius=8)
    options_frame.pack(fill="x", pady=10)
    
    # Checkbox 1: Create Desktop Shortcut
    self.create_shortcut_var = ctk.BooleanVar(value=True)
    shortcut_check = ctk.CTkCheckBox(
        options_frame,
        text="Create desktop shortcut",
        variable=self.create_shortcut_var,
        font=("Arial", 11),
        text_color=TEXT_COLOR,
        fg_color=ACCENT_COLOR,
        checkmark_color=PANEL_COLOR
    )
    shortcut_check.pack(anchor="w", padx=12, pady=(12, 8))
    
    # Checkbox 2: Launch After Installation
    self.launch_after_var = ctk.BooleanVar(value=True)
    launch_check = ctk.CTkCheckBox(
        options_frame,
        text="Launch application after installation",
        variable=self.launch_after_var,
        font=("Arial", 11),
        text_color=TEXT_COLOR,
        fg_color=ACCENT_COLOR,
        checkmark_color=PANEL_COLOR
    )
    launch_check.pack(anchor="w", padx=12, pady=(8, 12))
    
    # Summary frame
    summary_frame = ctk.CTkFrame(frame, fg_color=PANEL_COLOR, corner_radius=8)
    summary_frame.pack(fill="both", expand=True, pady=(20, 0))
    
    summary_label = ctk.CTkLabel(
        summary_frame,
        text="Configuration Summary:",
        font=("Arial", 11, "bold"),
        text_color=TEXT_COLOR
    )
    summary_label.pack(anchor="w", padx=12, pady=(12, 8))
    
    # Summary text
    summary_text = ctk.CTkTextbox(
        summary_frame,
        fg_color=BG_COLOR,
        text_color=MUTED_COLOR,
        border_width=0,
        height=120
    )
    summary_text.pack(fill="both", expand=True, padx=12, pady=(0, 12))
    summary_text.configure(state="disabled")
    
    # Build summary text
    self.summary_text_widget = summary_text  # Store for later update
    
    return frame
```

ADD NEW METHOD to update summary:
```python
def _update_finish_summary(self):
    """Update the summary text in finish screen."""
    if hasattr(self, 'summary_text_widget'):
        app_name = self.app_name_var.get() or "Universal Knowledge Assistant"
        model = self.model_dropdown.get() or "qwen2.5-coder:3b"
        
        summary = f"""
Assistant Name: {app_name}

Models Location: {self.models_path_var.get()}
Database Location: {self.db_path_var.get()}
Install Directory: {self.install_path_var.get()}

Selected Model: {model}

Create Shortcut: {'Yes' if self.create_shortcut_var.get() else 'No'}
Launch After Setup: {'Yes' if self.launch_after_var.get() else 'No'}
        """
        
        self.summary_text_widget.configure(state="normal")
        self.summary_text_widget.delete("1.0", tk.END)
        self.summary_text_widget.insert("1.0", summary.strip())
        self.summary_text_widget.configure(state="disabled")
```

---

LOCATION: Find the _go_next method (around line 650-700)

UPDATE THE validation logic:
```python
def _go_next(self):
    """Go to next screen."""
    # Validate current screen before proceeding
    if self.current_screen == 3:  # Configuration screen (was 2)
        if not self._validate_configuration():
            return
    
    if self.current_screen < len(self.screens) - 1:
        # If moving to finish screen, update summary
        if self.current_screen == 3:
            self.after(100, self._update_finish_summary)
        
        self._show_screen(self.current_screen + 1)
```

---

LOCATION: Find _on_finish method (around line 700-750)

REPLACE with:
```python
def _on_finish(self):
    """Handle finish button click - save config and optionally launch."""
    app_name = self.app_name_var.get() or "Universal Knowledge Assistant"
    selected_model = self.model_dropdown.get()
    
    if not selected_model:
        messagebox.showerror("Error", "Please select a model")
        return
    
    # Create configuration with paths
    success, message = self.backend.create_config(
        app_name=app_name,
        selected_model=selected_model,
        ollama_models_path=self.models_path_var.get(),
        database_path=self.db_path_var.get(),
        install_dir=self.install_path_var.get(),
        codebase_path=self.install_path_var.get()
    )
    
    if not success:
        messagebox.showerror("Configuration Error", message)
        return
    
    # Create desktop shortcut if checked
    if self.create_shortcut_var.get():
        shortcut_success, shortcut_msg = self.backend.create_desktop_shortcut(app_name)
        if not shortcut_success:
            messagebox.showwarning("Shortcut Warning", shortcut_msg)
    
    # Mark setup as complete
    self.backend.mark_setup_complete()
    
    # Show success message
    messagebox.showinfo(
        "Setup Complete",
        f"Configuration saved successfully!\n\n{app_name} is ready to use."
    )
    
    # Launch app if checked
    if self.launch_after_var.get():
        success, msg = self.backend.launch_main_app()
        if not success:
            messagebox.showwarning("Launch Failed", f"Could not launch app: {msg}")
    
    # Close setup wizard
    self.destroy()
```

---

LOCATION: In _check_dependencies_thread method, find where available_models is set

ENSURE DEDUPLICATION when adding downloaded models:
```python
        if success:
            # Deduplicate models list
            model_name = self.backend.get_recommended_model()
            if model_name not in self.available_models:
                self.available_models.append(model_name)
```

---

LOCATION: Update all window title references

REPLACE ALL OCCURRENCES OF:
```
"Thurtea ¬∑ AetherMUD Assistant"
```

WITH:
```
"Universal Knowledge Assistant - Setup"
```

Search and replace in:
- Line ~60 (in __init__)
- Line ~80 (in _create_welcome_screen)
- Anywhere else it appears
